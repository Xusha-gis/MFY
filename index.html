<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xarita Maydon - GeoJSON Exporter</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        :root {
            --primary: #2980b9;
            --secondary: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #17a2b8;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --border: #e0e0e0;
        }
        
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, var(--primary));
            color: white;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .logo i {
            font-size: 20px;
        }
        
        .header-controls {
            display: flex;
            gap: 6px;
        }
        
        .btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            background: rgba(255,255,255,0.2);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        .btn.active {
            background: var(--secondary);
        }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            justify-content: center;
            font-size: 1rem;
        }
        
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }
        
        #map {
            flex: 1;
            z-index: 1;
            min-height: 0;
        }
        
        .sidebar {
            position: absolute;
            right: 10px;
            top: 10px;
            bottom: 10px;
            width: 340px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        
        .sidebar.hidden {
            transform: translateX(calc(100% + 20px));
        }
        
        .sidebar-header {
            padding: 12px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .card {
            background: var(--bg);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid var(--border);
        }
        
        .card-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .card-title i {
            color: var(--primary);
            font-size: 0.9rem;
        }
        
        .form-group {
            margin-bottom: 8px;
        }
        
        .form-label {
            display: block;
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
        }
        
        textarea {
            resize: vertical;
            min-height: 50px;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .btn-group .btn {
            flex: 1;
            min-width: calc(50% - 3px);
            background: var(--primary);
            color: white;
            font-size: 0.75rem;
        }
        
        .btn-group .btn:hover {
            background: #1a5276;
        }
        
        .btn-success { background: var(--secondary) !important; }
        .btn-success:hover { background: #1e8449 !important; }
        
        .btn-danger { background: var(--danger) !important; }
        .btn-danger:hover { background: #c0392b !important; }
        
        .btn-warning { background: var(--warning) !important; color: white !important; }
        .btn-warning:hover { background: #d68910 !important; }
        
        .btn-info { background: var(--info) !important; color: white !important; }
        .btn-info:hover { background: #138496 !important; }
        
        .result-box {
            background: #e8f6f3;
            border-left: 3px solid var(--secondary);
            padding: 10px;
            border-radius: 0 6px 6px 0;
            font-size: 0.85rem;
        }
        
        .result-box h4 {
            font-size: 0.8rem;
            color: var(--text);
            margin-bottom: 6px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            padding: 4px 0;
            border-bottom: 1px dashed #ddd;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 600;
            color: #555;
        }
        
        .result-value {
            color: var(--primary);
            font-weight: 600;
        }
        
        .feature-list {
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .feature-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .feature-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .feature-item.selected {
            border-color: var(--primary);
            background: #e8f4fc;
        }
        
        .feature-item.boundary {
            border-left: 4px solid var(--info);
            background: #e7f3ff;
        }
        
        .feature-info {
            flex: 1;
        }
        
        .feature-name {
            font-weight: 600;
            color: var(--text);
        }
        
        .feature-meta {
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px;
        }
        
        .feature-actions {
            display: flex;
            gap: 4px;
        }
        
        .feature-actions button {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-edit { background: var(--primary); color: white; }
        .btn-delete { background: var(--danger); color: white; }
        
        .coords-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 8px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }
        
        .coords-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
        }
        
        .coords-label {
            font-weight: 600;
            color: #856404;
        }
        
        .map-type-select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 0.85rem;
        }
        
        .sidebar-toggle {
            position: absolute;
            right: 10px;
            top: 10px;
            z-index: 1001;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--card-bg);
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--text);
            transition: all 0.3s;
        }
        
        .sidebar-toggle:hover {
            transform: scale(1.1);
            background: var(--primary);
            color: white;
        }
        
        .status-box {
            font-size: 0.75rem;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .status-box.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-box.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-box.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--secondary);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            padding: 16px;
        }
        
        .modal-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 3px;
        }
        
        @media (max-width: 768px) {
            header {
                padding: 6px 10px;
            }
            
            .logo span {
                display: none;
            }
            
            .header-controls .btn-text {
                display: none;
            }
            
            .sidebar {
                width: calc(100% - 20px);
                max-width: 360px;
                right: 10px;
                left: 10px;
                top: auto;
                bottom: 10px;
                max-height: 60vh;
            }
            
            .sidebar.hidden {
                transform: translateY(calc(100% + 20px));
            }
            
            .sidebar-toggle {
                top: auto;
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
        }
        
        .custom-popup {
            font-size: 0.9rem;
            min-width: 200px;
        }
        
        .popup-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1rem;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 4px;
        }
        
        .popup-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            padding: 3px 0;
            border-bottom: 1px dotted #eee;
        }
        
        .popup-label {
            font-weight: 600;
            color: #555;
        }
        
        .popup-value {
            color: var(--text);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-map-marked-alt"></i>
            <span>Xarita Maydon</span>
        </div>
        <div class="header-controls">
            <button class="btn" id="drawPolygonBtn" title="Maydon chizish (Hovli, Dala)">
                <i class="fas fa-draw-polygon"></i>
                <span class="btn-text">Maydon</span>
            </button>
            <button class="btn" id="drawLineBtn" title="Chiziq chizish">
                <i class="fas fa-route"></i>
                <span class="btn-text">Chiziq</span>
            </button>
            <button class="btn" id="getCoordinateBtn" title="Koordinata olish">
                <i class="fas fa-crosshairs"></i>
                <span class="btn-text">GPS</span>
            </button>
        </div>
    </header>
    
    <div class="main-container">
        <div id="map"></div>
        
        <button class="sidebar-toggle" id="toggleSidebar">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title"><i class="fas fa-cogs"></i> Boshqaruv</span>
                <button class="btn btn-icon" id="closeSidebar" style="width: 28px; height: 28px; background: transparent; color: #666;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="sidebar-content">
                <!-- Status -->
                <div id="statusBox" class="status-box loading">
                    <i class="fas fa-spinner fa-spin"></i> XonqaMFY.geojson yuklanmoqda...
                </div>
                
                <!-- Xarita turi -->
                <div class="card">
                    <div class="card-title"><i class="fas fa-layer-group"></i> Xarita turi</div>
                    <select class="map-type-select" id="mapTypeSelect">
                        <option value="osm">OpenStreetMap</option>
                        <option value="google">Google Xarita</option>
                        <option value="satellite">Sputnik Tasvir</option>
                    </select>
                </div>
                
                <!-- Joriy koordinata -->
                <div class="card">
                    <div class="card-title"><i class="fas fa-map-pin"></i> Joriy koordinata</div>
                    <div class="coords-box">
                        <div class="coords-row">
                            <span class="coords-label">Kenglik:</span>
                            <span id="latValue">---</span>
                        </div>
                        <div class="coords-row">
                            <span class="coords-label">Uzunlik:</span>
                            <span id="lngValue">---</span>
                        </div>
                    </div>
                    <button class="btn" id="copyCoordinatesBtn" style="width: 100%; margin-top: 8px; background: var(--primary); color: white;">
                        <i class="fas fa-copy"></i> Nusxalash
                    </button>
                </div>
                
                <!-- Barcha obyektlar -->
                <div class="card">
                    <div class="card-title"><i class="fas fa-list"></i> Barcha obyektlar</div>
                    <div id="featureList" class="feature-list">
                        <p style="color: #999; font-size: 0.8rem; text-align: center;">Yuklanmoqda...</p>
                    </div>
                    <div class="btn-group" style="margin-top: 8px;">
                        <button class="btn btn-success" id="exportGeoJsonBtn">
                            <i class="fas fa-download"></i> Saqlash
                        </button>
                        <button class="btn btn-warning" id="importGeoJsonBtn">
                            <i class="fas fa-upload"></i> Ochish
                        </button>
                    </div>
                    <input type="file" id="importFile" accept=".geojson,.json" style="display: none;">
                </div>
                
                <!-- Tanlangan obyekt -->
                <div class="card" id="selectedFeatureCard" style="display: none;">
                    <div class="card-title"><i class="fas fa-info-circle"></i> Obyekt ma'lumotlari</div>
                    <div id="featureDetails"></div>
                    <div class="btn-group" style="margin-top: 8px;">
                        <button class="btn" id="editFeatureBtn" style="background: var(--primary); color: white;">
                            <i class="fas fa-edit"></i> Tahrirlash
                        </button>
                        <button class="btn btn-danger" id="deleteFeatureBtn">
                            <i class="fas fa-trash"></i> O'chirish
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Obyekt ma'lumotlari</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nomi</label>
                    <input type="text" id="featureName" placeholder="Obyekt nomini kiriting...">
                </div>
                <div class="form-group">
                    <label class="form-label">Turi</label>
                    <select id="featureType">
                        <option value="uy">Uy / Hovli</option>
                        <option value="dala">Dala / Ekin maydoni</option>
                        <option value="bog">Bog' / O'rmon</option>
                        <option value="yulka">Yo'l / Yulka</option>
                        <option value="suv">Suv obyekti</option>
                        <option value="boshqa">Boshqa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Egasi (F.I.Sh)</label>
                    <input type="text" id="featureOwner" placeholder="Egasi ismini kiriting...">
                </div>
                <div class="form-group">
                    <label class="form-label">Kadastr raqami</label>
                    <input type="text" id="featureCadastre" placeholder="Kadastr raqami...">
                </div>
                <div class="form-group">
                    <label class="form-label">Izoh</label>
                    <textarea id="featureDesc" placeholder="Qo'shimcha ma'lumot..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()" style="background: #6c757d; color: white;">Bekor</button>
                <button class="btn btn-success" onclick="saveFeatureData()">Saqlash</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText"></span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
        // Global variables
        var map;
        var drawnItems = new L.FeatureGroup();
        var boundaryLayer = null;
        var selectedLayer = null;
        var selectedLayerId = null;
        var coordinateMode = false;
        var lastClickedLatLng = null;
        var coordinateMarker = null;
        var layerCounter = 0;
        var layersData = new Map();
        var isBoundaryLoaded = false;
        
        // Initialize
        function init() {
            initMap();
            loadXonqaBoundary();
            setupEventListeners();
        }
        
        // Initialize map
        function initMap() {
            map = L.map('map', {
                center: [41.45, 60.15],
                zoom: 13,
                zoomControl: true
            });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            map.addLayer(drawnItems);
            
            // Drawing event
            map.on(L.Draw.Event.CREATED, function(e) {
                handleDrawCreated(e);
            });
            
            // Map click
            map.on('click', function(e) {
                if (coordinateMode) {
                    updateCoordinates(e.latlng);
                    addCoordinateMarker(e.latlng);
                } else {
                    deselectAll();
                }
            });
            
            // Mouse move
            map.on('mousemove', function(e) {
                if (!coordinateMode) {
                    document.getElementById('latValue').textContent = e.latlng.lat.toFixed(6);
                    document.getElementById('lngValue').textContent = e.latlng.lng.toFixed(6);
                }
            });
        }
        
        // Load XonqaMFY.geojson
        function loadXonqaBoundary() {
            updateStatus('loading', 'XonqaMFY.geojson yuklanmoqda...');
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'XonqaMFY.geojson', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200 || xhr.status === 0) {
                        try {
                            var geojson = JSON.parse(xhr.responseText);
                            processBoundaryGeoJson(geojson);
                            updateStatus('success', 'XonqaMFY.geojson yuklandi!');
                        } catch (err) {
                            console.error('Parse error:', err);
                            updateStatus('error', 'GeoJSON xato! Faylni tekshiring');
                            updateFeatureList();
                        }
                    } else {
                        console.error('Load error:', xhr.status);
                        updateStatus('error', 'Fayl topilmadi! Qo\'lda yuklang');
                        updateFeatureList();
                    }
                }
            };
            xhr.onerror = function() {
                updateStatus('error', 'Yuklash xatosi! Qo\'lda yuklang');
                updateFeatureList();
            };
            xhr.send();
        }
        
        // Process boundary GeoJSON
        function processBoundaryGeoJson(geojson) {
            if (boundaryLayer) {
                map.removeLayer(boundaryLayer);
            }
            
            boundaryLayer = L.geoJSON(geojson, {
                style: {
                    color: '#17a2b8',
                    weight: 4,
                    fillOpacity: 0.05,
                    fillColor: '#17a2b8',
                    dashArray: '5, 5'
                },
                onEachFeature: function(feature, layer) {
                    var name = feature.properties && feature.properties.name ? feature.properties.name : 'Xonqa MFY';
                    layer.bindPopup('<b>' + name + '</b><br>MFY Chegarasi');
                }
            }).addTo(map);
            
            // Add to layersData
            var boundaryId = 'xonqa_boundary';
            layersData.set(boundaryId, {
                layer: boundaryLayer,
                properties: {
                    id: boundaryId,
                    name: 'Xonqa MFY Chegarasi',
                    type: 'boshqa',
                    owner: '',
                    cadastre: '',
                    description: 'Mahalla fuqarolar yig\'ini chegarasi',
                    isBoundary: true,
                    created: new Date().toLocaleString('uz-UZ')
                },
                isBoundary: true
            });
            
            // Fit bounds
            if (boundaryLayer.getBounds) {
                map.fitBounds(boundaryLayer.getBounds(), { padding: [50, 50], maxZoom: 15 });
            }
            
            isBoundaryLoaded = true;
            updateFeatureList();
            
            // Make boundary clickable
            boundaryLayer.on('click', function(e) {
                L.DomEvent.stopPropagation(e);
                selectFeature(boundaryId);
            });
        }
        
        // Handle draw created
        function handleDrawCreated(e) {
            var layer = e.layer;
            layerCounter++;
            var layerId = 'feature_' + layerCounter;
            layer.layerId = layerId;
            
            var measurements = calculateMeasurements(layer);
            
            var properties = {
                id: layerId,
                name: e.layerType === 'polygon' ? 'Maydon ' + layerCounter : 'Chiziq ' + layerCounter,
                type: e.layerType === 'polygon' ? 'dala' : 'yulka',
                owner: '',
                cadastre: '',
                description: '',
                created: new Date().toLocaleString('uz-UZ'),
                isBoundary: false
            };
            
            Object.assign(properties, measurements);
            
            layersData.set(layerId, {
                layer: layer,
                properties: properties,
                isBoundary: false
            });
            
            updateLayerPopup(layer, properties);
            
            layer.on('click', function(evt) {
                L.DomEvent.stopPropagation(evt);
                selectFeature(layerId);
            });
            
            drawnItems.addLayer(layer);
            updateFeatureList();
            selectFeature(layerId);
            
            showNotification('Obyekt qo\'shildi! Ma\'lumotlarni kiriting.', 'success');
            openEditModal(layerId);
        }
        
        // Calculate measurements
        function calculateMeasurements(layer) {
            var result = {};
            
            if (layer instanceof L.Polygon) {
                var latlngs = layer.getLatLngs()[0];
                var area = 0;
                
                for (var i = 0; i < latlngs.length; i++) {
                    var j = (i + 1) % latlngs.length;
                    area += latlngs[i].lng * latlngs[j].lat;
                    area -= latlngs[j].lng * latlngs[i].lat;
                }
                area = Math.abs(area) * 0.5 * 111.32 * 111.32 * 1000;
                
                result.area_m2 = Math.round(area);
                result.area_ha = (area / 10000).toFixed(2);
                result.area_km2 = (area / 1000000).toFixed(4);
                
                var perimeter = 0;
                for (var k = 0; k < latlngs.length; k++) {
                    var l = (k + 1) % latlngs.length;
                    perimeter += map.distance(latlngs[k], latlngs[l]);
                }
                result.perimeter_m = Math.round(perimeter);
                
            } else if (layer instanceof L.Polyline) {
                var lineLatLngs = layer.getLatLngs();
                var length = 0;
                for (var m = 0; m < lineLatLngs.length - 1; m++) {
                    length += map.distance(lineLatLngs[m], lineLatLngs[m+1]);
                }
                result.length_m = Math.round(length);
                result.length_km = (length / 1000).toFixed(2);
            }
            
            return result;
        }
        
        // Update layer popup
        function updateLayerPopup(layer, props) {
            var popupContent = '<div class="custom-popup">';
            popupContent += '<div class="popup-title">' + props.name + '</div>';
            
            if (props.type) {
                var typeNames = {
                    'uy': 'Uy / Hovli',
                    'dala': 'Dala / Ekin',
                    'bog': "Bog' / O'rmon",
                    'yulka': "Yo'l / Yulka",
                    'suv': 'Suv obyekti',
                    'boshqa': 'Boshqa'
                };
                popupContent += '<div class="popup-row">';
                popupContent += '<span class="popup-label">Turi:</span>';
                popupContent += '<span class="popup-value">' + (typeNames[props.type] || props.type) + '</span>';
                popupContent += '</div>';
            }
            
            if (props.area_ha) {
                popupContent += '<div class="popup-row">';
                popupContent += '<span class="popup-label">Maydon:</span>';
                popupContent += '<span class="popup-value">' + props.area_ha + ' ga</span>';
                popupContent += '</div>';
                
                popupContent += '<div class="popup-row">';
                popupContent += '<span class="popup-label">Kv.m:</span>';
                popupContent += '<span class="popup-value">' + props.area_m2.toLocaleString() + ' m2</span>';
                popupContent += '</div>';
            }
            
            if (props.length_m) {
                popupContent += '<div class="popup-row">';
                popupContent += '<span class="popup-label">Uzunlik:</span>';
                popupContent += '<span class="popup-value">' + props.length_m + ' m</span>';
                popupContent += '</div>';
            }
            
            if (props.owner) {
                popupContent += '<div class="popup-row">';
                popupContent += '<span class="popup-label">Egasi:</span>';
                popupContent += '<span class="popup-value">' + props.owner + '</span>';
                popupContent += '</div>';
            }
            
            if (props.cadastre) {
                popupContent += '<div class="popup-row">';
                popupContent += '<span class="popup-label">Kadastr:</span>';
                popupContent += '<span class="popup-value">' + props.cadastre + '</span>';
                popupContent += '</div>';
            }
            
            if (props.description) {
                popupContent += '<div class="popup-row" style="margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px;">';
                popupContent += '<span class="popup-value" style="font-style: italic; color: #666;">' + props.description + '</span>';
                popupContent += '</div>';
            }
            
            popupContent += '</div>';
            
            layer.bindPopup(popupContent);
        }
        
        // Select feature
        function selectFeature(layerId) {
            deselectAll();
            
            var data = layersData.get(layerId);
            if (!data) return;
            
            selectedLayerId = layerId;
            selectedLayer = data.layer;
            
            if (selectedLayer.setStyle && !data.isBoundary) {
                selectedLayer.setStyle({
                    color: '#e74c3c',
                    weight: 4,
                    fillOpacity: 0.4
                });
            }
            
            updateFeatureList();
            showFeatureDetails(data.properties, data.isBoundary);
            
            if (selectedLayer.getBounds) {
                map.fitBounds(selectedLayer.getBounds(), { padding: [50, 50], maxZoom: 18 });
            }
        }
        
        // Deselect all
        function deselectAll() {
            if (selectedLayer && selectedLayer.setStyle) {
                var data = layersData.get(selectedLayerId);
                if (data && !data.isBoundary) {
                    var isPolygon = selectedLayer instanceof L.Polygon;
                    selectedLayer.setStyle({
                        color: isPolygon ? '#2980b9' : '#e74c3c',
                        weight: isPolygon ? 3 : 4,
                        fillOpacity: 0.2
                    });
                }
            }
            selectedLayer = null;
            selectedLayerId = null;
            updateFeatureList();
            document.getElementById('selectedFeatureCard').style.display = 'none';
        }
        
        // Update feature list
        function updateFeatureList() {
            var container = document.getElementById('featureList');
            
            if (layersData.size === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 0.8rem; text-align: center;">Hozircha obyekt yo\'q</p>';
                return;
            }
            
            var html = '';
            layersData.forEach(function(data, id) {
                var props = data.properties;
                var isSelected = (id === selectedLayerId);
                var isBoundary = data.isBoundary;
                
                var sizeInfo = '';
                if (props.area_ha) {
                    sizeInfo = props.area_ha + ' ga';
                } else if (props.length_m) {
                    sizeInfo = props.length_m + ' m';
                }
                
                var ownerInfo = props.owner ? ' | ' + props.owner : '';
                var boundaryClass = isBoundary ? 'boundary' : '';
                var icon = isBoundary ? '<i class="fas fa-map-marked" style="color: #17a2b8; margin-right: 5px;"></i>' : '';
                
                html += '<div class="feature-item ' + boundaryClass + ' ' + (isSelected ? 'selected' : '') + '" onclick="selectFeature(\'' + id + '\')">';
                html += '<div class="feature-info">';
                html += '<div class="feature-name">' + icon + props.name + '</div>';
                if (!isBoundary) {
                    html += '<div class="feature-meta">' + sizeInfo + ownerInfo + '</div>';
                } else {
                    html += '<div class="feature-meta" style="color: #17a2b8;">MFY Chegarasi</div>';
                }
                html += '</div>';
                html += '<div class="feature-actions" onclick="event.stopPropagation()">';
                if (!isBoundary) {
                    html += '<button class="btn-edit" onclick="openEditModal(\'' + id + '\')" title="Tahrirlash"><i class="fas fa-edit"></i></button>';
                    html += '<button class="btn-delete" onclick="deleteFeature(\'' + id + '\')" title="O\'chirish"><i class="fas fa-trash"></i></button>';
                }
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        // Show feature details
        function showFeatureDetails(props, isBoundary) {
            var card = document.getElementById('selectedFeatureCard');
            var details = document.getElementById('featureDetails');
            
            var html = '<div class="result-box">';
            
            if (isBoundary) {
                html += '<div class="result-item">';
                html += '<span class="result-label">Turi:</span>';
                html += '<span class="result-value">MFY Chegarasi</span>';
                html += '</div>';
            }
            
            if (props.area_ha) {
                html += '<div class="result-item">';
                html += '<span class="result-label">Maydon:</span>';
                html += '<span class="result-value">' + props.area_ha + ' ga</span>';
                html += '</div>';
                
                html += '<div class="result-item">';
                html += '<span class="result-label">Kv.metr:</span>';
                html += '<span class="result-value">' + props.area_m2.toLocaleString() + ' m2</span>';
                html += '</div>';
                
                html += '<div class="result-item">';
                html += '<span class="result-label">Perimeter:</span>';
                html += '<span class="result-value">' + props.perimeter_m + ' m</span>';
                html += '</div>';
            }
            
            if (props.length_m) {
                html += '<div class="result-item">';
                html += '<span class="result-label">Uzunlik:</span>';
                html += '<span class="result-value">' + props.length_m + ' m</span>';
                html += '</div>';
                
                html += '<div class="result-item">';
                html += '<span class="result-label">Kilometr:</span>';
                html += '<span class="result-value">' + props.length_km + ' km</span>';
                html += '</div>';
            }
            
            html += '</div>';
            details.innerHTML = html;
            card.style.display = 'block';
            
            // Show/hide buttons based on boundary
            var editBtn = document.getElementById('editFeatureBtn');
            var deleteBtn = document.getElementById('deleteFeatureBtn');
            if (isBoundary) {
                editBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
            } else {
                editBtn.style.display = 'block';
                deleteBtn.style.display = 'block';
            }
        }
        
        // Update status box
        function updateStatus(type, message) {
            var box = document.getElementById('statusBox');
            box.className = 'status-box ' + type;
            
            var icon = '';
            if (type === 'loading') icon = '<i class="fas fa-spinner fa-spin"></i> ';
            else if (type === 'success') icon = '<i class="fas fa-check-circle"></i> ';
            else if (type === 'error') icon = '<i class="fas fa-exclamation-triangle"></i> ';
            
            box.innerHTML = icon + message;
        }
        
        // Modal functions
        function openEditModal(layerId) {
            var data = layersData.get(layerId);
            if (!data || data.isBoundary) return;
            
            selectedLayerId = layerId;
            var props = data.properties;
            
            document.getElementById('featureName').value = props.name || '';
            document.getElementById('featureType').value = props.type || 'dala';
            document.getElementById('featureOwner').value = props.owner || '';
            document.getElementById('featureCadastre').value = props.cadastre || '';
            document.getElementById('featureDesc').value = props.description || '';
            
            document.getElementById('editModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
        }
        
        function saveFeatureData() {
            if (!selectedLayerId) return;
            
            var data = layersData.get(selectedLayerId);
            if (!data || data.isBoundary) return;
            
            data.properties.name = document.getElementById('featureName').value || data.properties.name;
            data.properties.type = document.getElementById('featureType').value;
            data.properties.owner = document.getElementById('featureOwner').value;
            data.properties.cadastre = document.getElementById('featureCadastre').value;
            data.properties.description = document.getElementById('featureDesc').value;
            
            updateLayerPopup(data.layer, data.properties);
            updateFeatureList();
            
            if (selectedLayerId) {
                showFeatureDetails(data.properties, data.isBoundary);
            }
            
            closeModal();
            showNotification('Ma\'lumotlar saqlandi!', 'success');
        }
        
        function deleteFeature(layerId) {
            if (!confirm('Haqiqatan ham o\'chirmoqchimisiz?')) return;
            
            var data = layersData.get(layerId);
            if (data && !data.isBoundary) {
                drawnItems.removeLayer(data.layer);
                layersData.delete(layerId);
                
                if (selectedLayerId === layerId) {
                    deselectAll();
                }
                
                updateFeatureList();
                showNotification('O\'chirildi!', 'success');
            }
        }
        
        // Export all to GeoJSON
        function exportGeoJson() {
            if (layersData.size === 0) {
                showNotification('Eksport qilish uchun obyekt yo\'q!', 'error');
                return;
            }
            
            var features = [];
            layersData.forEach(function(data, id) {
                if (data.isBoundary) return; // Skip boundary in export
                
                var geojson = data.layer.toGeoJSON();
                geojson.properties = {};
                for (var key in data.properties) {
                    if (key !== 'isBoundary') {
                        geojson.properties[key] = data.properties[key];
                    }
                }
                features.push(geojson);
            });
            
            if (features.length === 0) {
                showNotification('Saqlash uchun obyekt yo\'q!', 'error');
                return;
            }
            
            var featureCollection = {
                type: 'FeatureCollection',
                features: features,
                created: new Date().toISOString(),
                count: features.length
            };
            
            var dataStr = JSON.stringify(featureCollection, null, 2);
            var dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            var link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'xonqa_mfy_' + new Date().toISOString().slice(0, 10) + '.geojson';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(features.length + ' ta obyekt saqlandi!', 'success');
        }
        
        // Import GeoJSON
        function importGeoJson(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var geojson = JSON.parse(e.target.result);
                    
                    if (geojson.type === 'FeatureCollection' && geojson.features) {
                        var count = 0;
                        geojson.features.forEach(function(feature) {
                            if (!feature.geometry) return;
                            
                            var layer = L.geoJSON(feature).getLayers()[0];
                            if (!layer) return;
                            
                            layerCounter++;
                            var layerId = 'imported_' + layerCounter;
                            layer.layerId = layerId;
                            
                            var measurements = calculateMeasurements(layer);
                            var properties = {
                                id: layerId,
                                name: (feature.properties && feature.properties.name) ? feature.properties.name : 'Obyekt ' + layerCounter,
                                type: (feature.properties && feature.properties.type) ? feature.properties.type : 'boshqa',
                                owner: (feature.properties && feature.properties.owner) ? feature.properties.owner : '',
                                cadastre: (feature.properties && feature.properties.cadastre) ? feature.properties.cadastre : '',
                                description: (feature.properties && feature.properties.description) ? feature.properties.description : '',
                                created: new Date().toLocaleString('uz-UZ'),
                                isBoundary: false
                            };
                            
                            for (var key in measurements) {
                                properties[key] = measurements[key];
                            }
                            
                            layersData.set(layerId, {
                                layer: layer,
                                properties: properties,
                                isBoundary: false
                            });
                            
                            var isPolygon = layer instanceof L.Polygon;
                            layer.setStyle({
                                color: isPolygon ? '#2980b9' : '#e74c3c',
                                weight: isPolygon ? 3 : 4,
                                fillOpacity: 0.2
                            });
                            
                            updateLayerPopup(layer, properties);
                            
                            layer.on('click', function(evt) {
                                L.DomEvent.stopPropagation(evt);
                                selectFeature(layerId);
                            });
                            
                            drawnItems.addLayer(layer);
                            count++;
                        });
                        
                        updateFeatureList();
                        showNotification(count + ' ta obyekt yuklandi!', 'success');
                    }
                } catch (err) {
                    showNotification('Xatolik! Noto\'g\'ri GeoJSON', 'error');
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }
        
        // Other functions
        function updateCoordinates(latlng) {
            lastClickedLatLng = latlng;
            document.getElementById('latValue').textContent = latlng.lat.toFixed(6);
            document.getElementById('lngValue').textContent = latlng.lng.toFixed(6);
        }
        
        function addCoordinateMarker(latlng) {
            if (coordinateMarker) {
                map.removeLayer(coordinateMarker);
            }
            
            coordinateMarker = L.marker(latlng).addTo(map);
            coordinateMarker.bindPopup('<b>Koordinata:</b><br>' + latlng.lat.toFixed(6) + ', ' + latlng.lng.toFixed(6)).openPopup();
        }
        
        function copyCoordinates() {
            if (!lastClickedLatLng) {
                showNotification('Avval koordinata tanlang!', 'error');
                return;
            }
            
            var text = lastClickedLatLng.lat.toFixed(6) + ', ' + lastClickedLatLng.lng.toFixed(6);
            navigator.clipboard.writeText(text).then(function() {
                showNotification('Koordinata nusxalandi!', 'success');
            });
        }
        
        function changeMapType(type) {
            map.eachLayer(function(layer) {
                if (layer._url) map.removeLayer(layer);
            });
            
            var url;
            if (type === 'google') {
                url = 'https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}';
            } else if (type === 'satellite') {
                url = 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}';
            } else {
                url = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            }
            
            L.tileLayer(url, {
                maxZoom: 20,
                attribution: type === 'osm' ? 'OpenStreetMap' : 'Google'
            }).addTo(map);
            
            map.addLayer(drawnItems);
            if (boundaryLayer) map.addLayer(boundaryLayer);
        }
        
        function toggleCoordinateMode() {
            coordinateMode = !coordinateMode;
            var btn = document.getElementById('getCoordinateBtn');
            
            if (coordinateMode) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-times"></i><span class="btn-text">Bekor</span>';
                map.getContainer().style.cursor = 'crosshair';
                showNotification('Koordinata olish rejimi', 'info');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-crosshairs"></i><span class="btn-text">GPS</span>';
                map.getContainer().style.cursor = '';
                if (coordinateMarker) map.removeLayer(coordinateMarker);
            }
        }
        
        function showNotification(text, type) {
            var notif = document.getElementById('notification');
            var icon = 'check-circle';
            var color = '#27ae60';
            
            if (type === 'error') {
                icon = 'exclamation-circle';
                color = '#e74c3c';
            } else if (type === 'warning') {
                icon = 'exclamation-triangle';
                color = '#f39c12';
            } else if (type === 'info') {
                icon = 'info-circle';
                color = '#3498db';
            }
            
            notif.innerHTML = '<i class="fas fa-' + icon + '"></i> <span>' + text + '</span>';
            notif.style.background = color;
            
            notif.classList.add('show');
            setTimeout(function() {
                notif.classList.remove('show');
            }, 3000);
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden');
        }
        
        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('drawPolygonBtn').addEventListener('click', function() {
                new L.Draw.Polygon(map, {
                    allowIntersection: false,
                    shapeOptions: { color: '#2980b9', weight: 3, fillOpacity: 0.2 }
                }).enable();
            });
            
            document.getElementById('drawLineBtn').addEventListener('click', function() {
                new L.Draw.Polyline(map, {
                    shapeOptions: { color: '#e74c3c', weight: 4 }
                }).enable();
            });
            
            document.getElementById('getCoordinateBtn').addEventListener('click', toggleCoordinateMode);
            document.getElementById('copyCoordinatesBtn').addEventListener('click', copyCoordinates);
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('closeSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('editFeatureBtn').addEventListener('click', function() {
                if (selectedLayerId) openEditModal(selectedLayerId);
            });
            document.getElementById('deleteFeatureBtn').addEventListener('click', function() {
                if (selectedLayerId) deleteFeature(selectedLayerId);
            });
            document.getElementById('exportGeoJsonBtn').addEventListener('click', exportGeoJson);
            document.getElementById('importGeoJsonBtn').addEventListener('click', function() {
                document.getElementById('importFile').click();
            });
            document.getElementById('importFile').addEventListener('change', importGeoJson);
            document.getElementById('mapTypeSelect').addEventListener('change', function(e) {
                changeMapType(e.target.value);
            });
            
            document.getElementById('editModal').addEventListener('click', function(e) {
                if (e.target.id === 'editModal') closeModal();
            });
        }
        
        // Start
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
